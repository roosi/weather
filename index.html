<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>My Weather</title>
<link rel="stylesheet" type="text/css" href="css/style.css" media="screen, handheld" />
<link rel="stylesheet" type="text/css" href="css/enhanced.css" media="screen  and (min-width: 40.5em)" />
<!--[if (lt IE 9)&(!IEMobile)]>
<link rel="stylesheet" type="text/css" href="css/enhanced.css" />
<![endif]-->
<script src="js/jquery-2.0.2.min.js" type="text/javascript" ></script>
<script src="js/service.js" type="text/javascript" ></script>
<script src="js/utils.js" type="text/javascript" ></script>
<script src="http://maps.google.com/maps/api/js?sensor=false"></script>
<script type="text/javascript" >

var service = new Service();
var geocoder;
var map;

function initialize() {
	geocoder = new google.maps.Geocoder();
 var latlng = new google.maps.LatLng(0, 0);
 var mapOptions = {
 		zoom: 16,
		center: latlng,
		mapTypeId: google.maps.MapTypeId.ROADMAP
	}
	var mapdiv = document.getElementById("map-canvas");

	map = new google.maps.Map(mapdiv, mapOptions);
	map.setTilt(45);
}

$(document).ready(function(){
	$("#temperature").html("Loading ...");

	service.getMyLocation(
		function(position){
			$("#location").html("Latitude: " + position.coords.latitude + " Longitude: " + position.coords.longitude);
			
			// get location name based on coordinates of my location
			if (geocoder) {			
				var latlng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
				geocoder.geocode({"latLng" : latlng }, function (results, status) {
         if (status == google.maps.GeocoderStatus.OK) {
            $("#location").html(results[0].formatted_address);
            
											map.setCenter(results[0].geometry.location);
											map.panBy(0,-	150);
        				var marker = new google.maps.Marker({
            		map: map,
												position: results[0].geometry.location
											});
         }
         else {
            alert("Geocoding failed: " + status);
         }
   		});
  		}
  		else {
  			alert("getMyLocation: No geocoder");
  		}

			// get weather based on coordinates of my location
			service.getWeatherByCoords(
				position.coords.latitude, 
				position.coords.longitude,
				utils.getDefaultLocale(),
				function(result){	 
					$("#temperature").html(result.main.temp + " °C");
					var weather = document.getElementById("weather");
					showImage("http://openweathermap.org/img/w/" + result.weather[0].icon, 
						50, 50, result.weather[0].main, weather);
				},
				function(error){
					alert("getWeatherByCoords: " + error);
				}
			);	
			
			// get forecast based on coordinates of my location
			service.getDailyForecastByCoords(
				position.coords.latitude, 
				position.coords.longitude,
				utils.getDefaultLocale(),
				function(result){	 
					buildForecastList(result.list);
				},
				function(error){
					alert("getDailyForecastByCoords: " + error);
				}
			);	

		},
		function(error){
			alert(error)
		}
	);
});

function buildForecastList(list) {
	var forecast = document.getElementById("forecast");
	var ul = document.createElement("ul");
	forecast.appendChild(ul);
	var json = { items: ["item 1", "item 2", "item 3"] };
	$(list).each(function(index, item) {
		var date = new Date(item.dt * 1000);
		var li = document.createElement("li");
		li.setAttribute("class", "forecast-list-item");
		li.innerHTML = "<p>" + date + "</p>" +
			"<p>Day " + item.temp.day + " °C</p>" +
			"<p>Night " + item.temp.night + " °C</p>" +
			"<p>" + item.weather[0].description + "</p>" +
			//http://openweathermap.org/img/w/10d.png
			"<img src=http://openweathermap.org/img/w/" + item.weather[0].icon + " alt=" + item.weather[0].main + ">" +
			"</br>";
  	ul.appendChild(li);
	});
}

function showImage(src, width, height, alt, dest) {
    var img = document.createElement("img");
    img.src = src;
    img.width = width;
    img.height = height;
    img.alt = alt;
    img.setAttribute("class", "image");

    // This next line will just add it to the <body> tag
    dest.appendChild(img);
}

</script>
</head>
<body onload="initialize()">
	<div class="content" role="main">
		<section class="map-main">
			<div id="map-canvas"></div>
			<div id="panel">
				<p id="temperature" class="temperature"></p>
				<div id="weather"></div>
				<p id="location" class="location"></p>
			</div>
		</section>
		<section id="forecast" class="forecast">
		</section>
	</div>
</body>
</html>

